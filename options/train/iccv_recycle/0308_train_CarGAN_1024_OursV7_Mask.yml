# general settings
name: 0308_train_CarGAN_512_OursV7_Mask_from64
model_type: FaceGAN_Model_0922
num_gpu: 1  # set num_gpu: 0 for cpu mode
manual_seed: 0
is_mimo: true

# dist: true
# find_unused_parameters: true

# dataset and data loader settings
datasets:
  train:
    name: Standford_Car
    type: Car_Dataset
    dataroot_gt: ~
    dataroot_gt_list: ['datasets/Image_Generation/LSUN/cars/cars_train'] 
                      #  ,'datasets/Image_Generation/CelebA/CelebAMask-HQ/CelebA-HQ-split/train'
                      #  ,'datasets/Image_Generation/CelebA/CelebAMask-HQ/CelebA-HQ-split/val']
    # dataroot_gt: datasets/Image_Generation/CelebA/CelebAMask-HQ/CelebA-HQ-img
    # dataroot_gt: datasets/Image_Generation/CelebA/CelebAMask-HQ/CelebA-HQ-identity-sep
    mode: mix_id
    gt_size: [512, 384]
    max_length: 1
    fix_input: false
    random_seed: 0
    io_backend:
      type: disk
    use_hflip: true
    mean: [0.5, 0.5, 0.5]
    std: [0.5, 0.5, 0.5]

    # data loader
    use_shuffle: true
    num_worker_per_gpu: 1
    batch_size_per_gpu: 2
    dataset_enlarge_ratio: 100 # 100
    prefetch_mode: ~

  val:
    name: Car_val
    type: Car_Dataset
    dataroot_gt: datasets/Image_Generation/LSUN/cars/cars_val
    mode: mix_id
    gt_size: [512, 384]
    max_length: 1
    fix_input: false
    random_seed: 0
    io_backend:
      type: disk
    use_hflip: false
    mean: [0.5, 0.5, 0.5]
    std: [0.5, 0.5, 0.5]

# network structures
network_g:
  type: pSp_like_inversion_v7_car
  out_size: 512
  style_dim: 512
  StyleGAN_pth: experiments/pretrained_models/StyleGAN2/stylegan2-car-config-f.pt
  StyleGAN_pth_key: g_ema
  avg_latent_pth: experiments/pretrained_models/StyleGAN2/stylegan2-car-config-f_avg_latent.pth
  E4E_pth: experiments/pretrained_models/inversion/e4e_cars_encode.pt
  norm_type: false
  encode_to_w: true
  encoder: E4E
  enable_modulation: true
  styled_modulation: true
  noiseInj_modulation: true
  mod_btn: None #styleBlock
  modulation_type: NOISE
  reWeightNoiseInj: true
  align_modulation: true
  warp_scale: 0.02
  cycle_align: 2
  blend_with_gen: true
  aug_style: false
  aug_style_params:
    prob: 0.8
    eigen_index_range: [0, 10]
    edit_layers: ['4:8', '8:']
    strength: [2, 20]
  ModSize: ~
  progressiveModSize: [64, 128, 256]
  progressiveModFrozen: false
  ModDropout_p: 0.0
  stage: Inference
  progressiveStart: 2000 # 5000
  progressiveStep: 4000 # 25000
  progressiveStageSteps: ~ # leave it none for automatic gensssseration

network_d:
  type: StyleGAN2Discriminator_mod
  out_size: 512
  channel_multiplier: 2
  resample_kernel: [1, 3, 3, 1]

network_d2:
  type: LatentDiscrinimator
  chn: 18
  dim: 512
  n_mlp: 8
  hidden_chn: 4

# path
path:
  pretrain_network_g: ~
  param_key_g: 'params_ema'
  strict_load_g: false
  pretrain_network_d: ~ #experiments/pretrained_models/StyleGAN2/stylegan2_ffhq_config_f_1024_discriminator_official-a386354a.pth
  param_key_d: 'params'
  strict_load_d: true
  resume_state: ~
  
# training settings
train:
  optim_g:
    type: Adam
    lr: !!float 2e-5
    generator_lr_decay: !!float 1.0

  optim_d:
    type: Adam
    lr: !!float 2e-5

  optim_d2:
    type: Adam
    lr: !!float 2e-6

  scheduler:
    type: MultiStepLR
    milestones: 15000
    gamma: 0.75

  total_iter: 1800000
  warmup_iter: -1  # no warm up

  # fix generator before startup_iter
  startup_iter: 1800000
  fix_and_grad: 
    fix: ['generator', 'avg_latent', 'encoder'] # , 'alignment', 'residual_encoder'
    grad: []

  autocast: false
  skip_latent_g: true
  skip_gen_g: false
  which_gt: gt
  grad_clip_norm: 999.0

  # losses
  gan_opt:
    type: GANLoss
    gan_type: wgan_softplus
    loss_weight: !!float 5e-1

  # r1 regularization for discriminator
  r1_reg_weight: 10
  # path length regularization for generator
  path_batch_shrink: 2
  path_reg_weight: 2

  net_g_reg_every: 99999999 # 4
  net_d_reg_every: 99999999 # 16
  mixing_prob: 0.9

  net_d_iters: 1
  net_d_init_iters: 0

  pix_opt:
    type: MSELoss
    loss_weight: 1.0

  # id_opt:
  #   type: IDLoss
  #   loss_weight: 0.1
  #   ref_loss_weight: 0.0
  #   ckpt: experiments/pretrained_models/ir_se/model_ir_se50.pth

  # perceptual_opt:
  #   type: LPIPS_Loss
  #   loss_weight: 0.8
  #   min_max: [-1, 1]
  #   net: alex

  perceptual_opt:
      type: PerceptualLoss
      layer_weights:
        # before relu
        'conv1_2': 0.1
        'conv2_2': 0.1
        'conv3_4': 1
        'conv4_4': 1
        'conv5_4': 1
      vgg_type: vgg19
      use_input_norm: true
      perceptual_weight: !!float 1.0
      style_weight: 50
      range_norm: true
      criterion: l1

  mask_opt:
    type: MaskLoss
    loss_weight: 10.0
    loss_func:
      binary: [32, 64, 128, 256, 512]
      # area:
      #   '32': 0.6
      #   '64': 0.45
      #   '128': 0.35
      #   '256': 0.35
      # target: 0
      # binary_weight: !!float 2e-2
      area:
        '32': 0.15
        '64': 0.15
        '128': 0.10
        '256': 0.10
        '512': 0.10
      target: 1
      binary_weight: !!float 4e-2

# validation settings
val:
  val_freq: !!float 2e3
  save_img: true
  save_lq_and_gt: true
  pbar: true

  metrics:
    lpips:
      type: calculate_lpips
      crop_border: 2
      test_y_channel: true
      model_path: experiments/pretrained_models/lpips/alex.pth
      better: lower
    psnr:
      type: calculate_psnr
      crop_border: 2
      test_y_channel: true
      better: higher
    ssim:
      type: calculate_ssim
      crop_border: 2
      test_y_channel: true
      better: higher

# logging settings
logger:
  print_freq: 100
  save_checkpoint_freq: !!float 4e3
  use_tb_logger: true
  wandb:
    project: ~ # reproduce-project
    resume_id: ~

# dist training settings
dist_params:
  backend: nccl
  port: 29500


# on RTX3090 server
# export TORCH_CUDA_ARCH_LIST=8.0